<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pickup Operations | Discovery Hike</title>
<link rel="icon" href="favicon.ico" type="image/x-icon">
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
/* ================= THEME VARIABLES ================= */
:root {
  --primary: #00254d;
  --accent: #004b99;
  --danger: #c62828;

  --bg: #f4f6f8;
  --card: #ffffff;
  --border: #e5e7eb;
  --text: #333;
  --muted: #666;

  --safe: #16a34a;
  --warn: #f59e0b;
}

/* DARK MODE */
body.dark {
  --bg: #0f172a;
  --card: #111827;
  --border: #1f2937;
  --text: #e5e7eb;
  --muted: #9ca3af;
}


* { box-sizing: border-box }

body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
               Roboto, Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
  transition: background 0.3s ease, color 0.3s ease;
}

/* Passenger row background */
.batch-sub.passenger {
  display: flex;
  justify-content: space-between;
  gap: 12px;
  background: rgba(0,0,0,0.03);
  padding: 10px;
  border-radius: 10px;
  margin-bottom: 8px;
}

body.dark .batch-sub.passenger {
  background: rgba(255,255,255,0.04);
}

.header-gradient {
  background: linear-gradient(135deg, #00254d, #004b99);
  padding: 22px 20px 24px;
  border-bottom-left-radius: 18px;
  border-bottom-right-radius: 18px;
  box-shadow: 0 10px 24px rgba(0,0,0,0.18);
  min-height: 120px;   /* matches 75px logo nicely */
}


/* ===== HEADER LAYOUT LOCK ===== */
.header-inner {
  max-width: 1000px;
  margin: 0 auto;

  display: flex;
  align-items: center;
  gap: 16px;

  justify-content: flex-start;
  text-align: left;
}


/* text block */
.header-text h1 {
  margin: 0;
  font-size: 22px;
  font-weight: 700;
  line-height: 1.25;
}

.header-text p {
  margin: 4px 0 0;
  font-size: 14px;
  opacity: 0.95;
}

.header-gradient h1,
.header-gradient p {
  color: #ffffff;
}

.header-text {
  padding-top: 4px;
}


/* ===== LOGO SIZE LOCK ===== */
.logo-top {
  height: 75px;          /* desktop */
  width: auto;
  flex-shrink: 0;
  object-fit: contain;
  opacity: 0.95;
}


@media (max-width: 900px) {
  .logo-top {
    height: 56px;
  }
}

@media (max-width: 600px) {
  .logo-top {
    height: 42px;   /* phone-friendly */
  }
}


.toggle {
  position: fixed;
  top: 14px;
  right: 14px;
  background: var(--card);
  border-radius: 50px;
  padding: 6px 12px;
  font-size: 12px;
  cursor: pointer;
  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
  z-index: 100;
}

.container {
  max-width:1000px;
  margin:auto;
  padding:16px;
}

.batch {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 16px;
  margin-bottom: 16px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.08);
  transition: box-shadow 0.2s ease;
}

body.dark .batch {
  box-shadow: 0 10px 24px rgba(0,0,0,0.45);
}


.batch-header {
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:12px;
}

.batch-title {
  font-size:15px;
  font-weight:600;
}

.batch-sub {
  font-size:12px;
  color:var(--muted);
}

.progress {
  height: 8px;
  border-radius: 999px;
  background: var(--border);
  margin-top: 8px;
  overflow: hidden;
}

body.dark .progress {
  background: #020617;
}


.actions {
  margin-top:10px;
}

button,
.btn {
  background: linear-gradient(135deg, #00254d, #004b99);
  color: #fff;
  border: none;
  border-radius: 10px;
  padding: 8px 14px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.12s ease, box-shadow 0.12s ease;
}

button:hover,
.btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 6px 16px rgba(0,0,0,0.25);
}

button:active,
.btn:active {
  transform: scale(0.97);
}

.status {
  font-size: 11px;
  font-weight: 700;
  padding: 4px 10px;
  border-radius: 999px;
}

.DRAFT { background:#e5e7eb; color:#374151 }
.VEHICLES_LOCKED { background:#fef3c7; color:#92400e }
.ALLOCATED { background:#dcfce7; color:#166534 }
.SENT { background:#bbf7d0; color:#065f46 }

body.dark .DRAFT {
  background:#334155;
  color:#e5e7eb;
}


.workspace {
  display:none;
  margin-top:14px;
  border-top:1px dashed var(--border);
  padding-top:14px;
}

.workspace.open { display:block }

.note {
  margin-top:10px;
  padding:10px;
  font-size:12px;
  border-radius:10px;
}
input, select {
  width: 100%;
  padding: 10px 12px;
  border-radius: 10px;
  border: 1px solid var(--border);
  font-size: 13px;
  margin-top: 8px;
  background: var(--card);
  color: var(--text);
}

input:focus, select:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(0,75,153,0.15);
}

body.dark input,
body.dark select {
  background: #020617;
  border-color: #1f2937;
  color: #e5e7eb;
}

.safe { background:#064e3b; color:#d1fae5 }

@media (max-width: 600px) {
  .batch-sub.passenger {
    flex-direction: column;
  }
}

</style>
</head>

<body>
<div class="toggle" onclick="toggleDark()">üåô / ‚òÄÔ∏è</div>

<header class="header-gradient">
  <div class="header-inner">
    <img src="https://i.imgur.com/40sl7Sv.png" alt="Discovery Hike" class="logo-top">
    <div class="header-text">
      <h1>Discovery Hike ‚Äì Pickup Operations</h1>
      <p>Internal transport & allocation system</p>
    </div>
  </div>
</header>



<div class="container">
  <div id="list">Loading pickup batches‚Ä¶</div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbyDkebftew8h2PBHpizEnvlSa9bBITn9TCQhjZmrtPkVDEyFNvB2xDU0C5povyzRDgE/exec";

let batches = [];
let vehicles = [];
let assignmentsCache = {};
let allocationCache = {};
/* ---------- INITIAL LOAD ---------- */
Promise.all([
  fetch(API + "?action=batches").then(r => r.json()),
  fetch(API + "?action=vehicles").then(r => r.json())
])
.then(([b, v]) => {
  batches = b;
  vehicles = v;
  render();
})
.catch(err => {
  alert("Failed to load pickup data");
  console.error(err);
});

/* ---------- RENDER ---------- */
function render() {
  const el = document.getElementById("list");
  el.innerHTML = "";

  batches.forEach(b => {
    const pct = b.totalPax
      ? Math.min(100, Math.round((b.assignedCapacity / b.totalPax) * 100))
      : 0;

    const barColor =
      b.assignedCapacity < b.totalPax ? "#f59e0b" : "#22c55e";

    el.innerHTML += `
      <div class="batch" id="batch-${b.batchId}">
        <div class="batch-header">
          <div>
            <div class="batch-title">${b.trekName}</div>
            <div class="batch-sub">${b.trekDate}</div>
          </div>
          <span class="status ${b.status}">${b.status}</span>
        </div>

        <div class="batch-sub">
          Pax: <b>${b.totalPax}</b> ‚Ä¢ Assigned: <b>${b.assignedCapacity}</b>
        </div>

        <div class="progress">
          <span style="width:${pct}%;background:${barColor}"></span>
        </div>

        <div class="actions">
          <button class="btn" onclick="toggleWorkspace('${b.batchId}')">
            Manage Batch
          </button>
        </div>

        <div class="workspace" id="ws-${b.batchId}"></div>
      </div>
    `;
  });
}

/* ---------- WORKSPACE ---------- */
function workspaceHTML(b) {
  const assigns = (assignmentsCache[b.batchId] || [])
    .filter(a => a.status === "ACTIVE");

  const allocs = allocationCache[b.batchId] || [];
  const editable = b.status === "ALLOCATED";

  // üîí Vehicle lock (NOT email sent)
  const locked = b.status !== "DRAFT";

  return `
    <h4>Assigned Vehicles</h4>

    ${assigns.length
      ? assigns.map(a => `
        <div class="batch-sub">
          üöê <b>${a.vehicleClass}</b> (${a.assignedPax} pax)<br>
          Vehicle No: ${a.vehicleNo || "‚Äî"}<br>
          Driver: ${a.driverName || "‚Äî"} (${a.driverPhone || "‚Äî"})<br>
          Pickup: ${a.pickupPoint || "‚Äî"} @ ${formatTime12h(a.pickupTime)}

        </div>
      `).join("")
      : "<div class='batch-sub'>No vehicles assigned</div>"
    }

    ${b.status === "VEHICLES_LOCKED" ? `
  <div class="actions">
    <button class="btn" onclick="allocatePassengers('${b.batchId}', this)">
      üë• Allocate Passengers
    </button>
  </div>
  <div class="note">
    Allocation will run once and cannot be re-run automatically.
  </div>
` : ""}



    ${!locked ? `
      <div class="actions">
        <button class="btn" onclick="lockVehicles('${b.batchId}', this)">
          üîí Lock Vehicles
        </button>
      </div>
      <div class="note">
        Lock vehicles before passenger allocation.
      </div>
    ` : `
      ${b.status === "VEHICLES_LOCKED" ? `
  <div class="note safe">
    Vehicles locked. Passenger allocation enabled.
  </div>
` : ""}

    `}

    <hr style="border-color:#1f2937;margin:10px 0">
${b.status === "ALLOCATED" ? `
  <div class="note safe">
    Vehicles are locked. Passenger allocation completed.
  </div>
` : ""}

   ${b.status === "ALLOCATED"
 ? `
  <h4>Passenger Allocation</h4>
<div id="swap-bar-${b.batchId}" style="display:none;margin:6px 0">
  <button class="btn"
    onclick="swapSelected('${b.batchId}')">
    üîÅ Swap Selected Passengers
  </button>
</div>

  ${allocs.length
    ? allocs.map(a => `
      <div class="batch-sub passenger">


        
        <div>
          ${editable ? `
<div style="display:flex;align-items:center;gap:6px;margin-bottom:4px">
  <input type="checkbox"
    class="swap-check"
    value="${a.id}"
    onchange="updateSwapBar('${b.batchId}')">
  <label style="font-size:11px;color:#9ca3af">
    Select for swap
  </label>
</div>
` : ""}



          üë§ <b>${a.email}</b><br>
          Pax: ${a.pax}<br>
          üöê ${a.vehicleClass} ${a.vehicleNo || ""}<br>
          üìç ${a.pickupPoint || "‚Äî"} @ ${a.pickupTime || "‚Äî"}<br>
          üë®‚Äç‚úàÔ∏è ${a.driverName || "‚Äî"} (${a.driverPhone || "‚Äî"})
        </div>

        <div style="display:flex;flex-direction:column;gap:6px">
  ${editable ? `
  <button class="btn"
    onclick="editAlloc('${a.id}', ${a.pax})">
    Edit
  </button>

  <button class="btn"
    onclick="cancelAlloc('${a.id}')">
    Cancel
  </button>
  ` : ""}

  ${editable ? `
  <select id="mv-${a.id}" onchange="this.nextElementSibling.disabled = !this.value">
    <option value="">Move to vehicle‚Ä¶</option>
    ${assigns.map(v => `
     <option 
  data-class="${v.vehicleClass}" 
  data-no="${v.vehicleNo || ""}">
  ${v.vehicleClass} ${v.vehicleNo || ""}
</option>

    `).join("")}
  </select>

  <button class="btn" disabled
    onclick="handleMove('${a.id}', 'mv-${a.id}')">
    Move
  </button>
  ` : ""}
</div>

      </div>
    `).join("")
    : "<div class='batch-sub'>No passengers allocated yet</div>"
  }
` : `
  <div class="note">
    Passenger allocation will appear after vehicles are locked.
  </div>
`}


    <hr style="border-color:#1f2937;margin:10px 0">

    <h4>Add Vehicle</h4>

    ${locked ? `
      <div class="note" style="background:#7c2d12;color:#fee2e2">
        Vehicles are locked. Cannot add or edit vehicles.
      </div>
    ` : `
      <select id="vc-${b.batchId}">
        <option value="">Select vehicle</option>
        ${vehicles.map(v =>
          `<option value="${v.class}">
            ${v.class} (${v.capacity})
          </option>`
        ).join("")}
      </select>

      <input placeholder="Vehicle Number" id="vn-${b.batchId}">
      <input placeholder="Driver Name" id="dn-${b.batchId}">
      <input placeholder="Driver Phone" id="dp-${b.batchId}">
      <input placeholder="Pickup Point" id="pp-${b.batchId}">
      <input type="time" id="pt-${b.batchId}">

      <div class="actions">
        <button class="btn" onclick="save('${b.batchId}', this)">
          Save Assignment
        </button>
      </div>

      <div class="note safe">
        Assigned pax is auto-calculated from vehicle capacity.
      </div>
    `}
  `;
}

function swapAlloc(idA, idB) {
  const params = new URLSearchParams({
    action: "swapAllocations",
    allocationIdA: idA,
    allocationIdB: idB
  });

  fetch(API + "?" + params.toString())
    .then(r => r.json())
    .then(res => {
      if (res.error) throw new Error(res.error);

      allocationCache = {};
      render();
    })
    .catch(err => alert(err.message));
}

/* ---------- TOGGLE ---------- */
function toggleWorkspace(batchId) {
  const ws = document.getElementById(`ws-${batchId}`);
  const isOpen = ws.classList.contains("open");

  document.querySelectorAll(".workspace.open").forEach(el => {
    el.classList.remove("open");
    el.innerHTML = "";
  });

  if (isOpen) return;

  ws.classList.add("open");
  ws.innerHTML = "<div class='batch-sub'>Loading data‚Ä¶</div>";

 const batch = batches.find(b => b.batchId === batchId);
 const shouldLoadAllocations =
  batch.status === "ALLOCATED";


Promise.all([
  assignmentsCache[batchId]
    ? Promise.resolve(assignmentsCache[batchId])
    : fetch(API + "?action=assignments&batchId=" + encodeURIComponent(batchId))
        .then(r => r.json())
        .then(d => (assignmentsCache[batchId] = d)),

  shouldLoadAllocations
    ? (allocationCache[batchId]
        ? Promise.resolve(allocationCache[batchId])
        : fetch(API + "?action=allocations&batchId=" + encodeURIComponent(batchId))
            .then(r => r.json())
            .then(d => (allocationCache[batchId] = d)))
    : Promise.resolve([])
])

  .then(() => {
    ws.innerHTML = workspaceHTML(
      batches.find(b => b.batchId === batchId)
    );
  })
  .catch(err => {
    console.error(err);
    ws.innerHTML = "<div class='batch-sub'>Failed to load batch data</div>";
  });
}

function allocatePassengers(batchId, btn) {
  if (!confirm("Allocate passengers now? This can only be done once.")) return;

  btn.disabled = true;
  btn.innerText = "Allocating‚Ä¶";

  fetch(API + `?action=allocatePassengers&batchId=${encodeURIComponent(batchId)}`)
    .then(r => r.json())
    .then(res => {
      if (res.error) throw new Error(res.error);

      allocationCache = {};
      return fetch(API + "?action=batches").then(r => r.json());
    })
    .then(b => {
      batches = b;
      render();
      requestAnimationFrame(() => toggleWorkspace(batchId));
    })
    .catch(err => {
      alert(err.message);
      btn.disabled = false;
      btn.innerText = "üë• Allocate Passengers";
    });
}

function formatTime12h(value) {
  if (!value) return "‚Äî";

  const d = new Date(value);
  if (isNaN(d)) return "‚Äî";

  let hours = d.getHours();
  const minutes = d.getMinutes().toString().padStart(2, "0");
  const ampm = hours >= 12 ? "PM" : "AM";

  hours = hours % 12 || 12;

  return `${hours}:${minutes} ${ampm}`;
}

/* ---------- SAVE ASSIGNMENT ---------- */
function save(batchId, btn) {
  btn.disabled = true;
  btn.innerText = "Saving‚Ä¶";

  const vc = document.getElementById(`vc-${batchId}`).value;
  if (!vc) {
    btn.disabled = false;
    btn.innerText = "Save Assignment";
    return alert("Select vehicle class");
  }

  const params = new URLSearchParams({
    action: "addAssignment",
    batchId: batchId,
    vehicleClass: vc,
    vehicleNo: document.getElementById(`vn-${batchId}`).value || "",
    driverName: document.getElementById(`dn-${batchId}`).value || "",
    driverPhone: document.getElementById(`dp-${batchId}`).value || "",
    pickupPoint: document.getElementById(`pp-${batchId}`).value || "",
    pickupTime: document.getElementById(`pt-${batchId}`).value || ""
  });

  fetch(API + "?" + params.toString())
    .then(r => r.json())
    .then(res => {
      if (res.error) throw new Error(res.error);

      assignmentsCache[batchId] = null;
      allocationCache[batchId] = null;

      return Promise.all([
        fetch(API + "?action=assignments&batchId=" + batchId).then(r => r.json()),
        fetch(API + "?action=batches").then(r => r.json())
      ]);
    })
    .then(([a, b]) => {
  assignmentsCache[batchId] = a;
  allocationCache[batchId] = []; // reset safely
  batches = b;


      btn.disabled = false;
      btn.innerText = "Save Assignment";

      render();

// ensure DOM is painted first
requestAnimationFrame(() => {
  toggleWorkspace(batchId);
});

    })
    .catch(err => {
      btn.disabled = false;
      btn.innerText = "Save Assignment";
      alert("Failed to save assignment: " + err.message);
      console.error(err);
    });
}
  
function lockVehicles(batchId, btn) {
  if (!confirm("Lock vehicles? You won‚Äôt be able to edit them later.")) return;

  btn.disabled = true;
  btn.innerText = "Locking‚Ä¶";

  fetch(API + "?action=lockVehicles&batchId=" + encodeURIComponent(batchId))
    .then(r => r.json())
    .then(res => {
      if (res.error) throw new Error(res.error);

      return fetch(API + "?action=batches").then(r => r.json());
    })
    .then(b => {
      batches = b;
      render();
      setTimeout(() => toggleWorkspace(batchId), 0);
    })
    .catch(err => {
      alert(err.message);
      btn.disabled = false;
      btn.innerText = "üîí Lock Vehicles";
    });
}

function updateSwapBar(batchId) {
  const checks = document.querySelectorAll(
    `#ws-${batchId} .swap-check:checked`
  );

  const bar = document.getElementById(`swap-bar-${batchId}`);
  bar.style.display = checks.length === 2 ? "block" : "none";
}

function swapSelected(batchId) {
  const ids = [...document.querySelectorAll(
    `#ws-${batchId} .swap-check:checked`
  )].map(c => c.value);

  if (ids.length !== 2) {
    return alert("Select exactly 2 passengers to swap");
  }

  if (!confirm("Swap these two passengers?")) return;

  const params = new URLSearchParams({
    action: "swapAllocations",
    allocationIdA: ids[0],
    allocationIdB: ids[1]
  });

  fetch(API + "?" + params.toString())
    .then(r => r.json())
    .then(res => {
      if (res.error) throw new Error(res.error);

      allocationCache = {};
      render();
    })
    .catch(err => alert(err.message));
}


function cancelAlloc(id) {
  if (!confirm("Cancel this allocation?")) return;

  fetch(API + "?action=cancelAllocation&allocationId=" + encodeURIComponent(id))
    .then(r => r.json())
    .then(() => {
      allocationCache = {};
      render();
    })
    .catch(e => alert(e.message));
}

function handleMove(allocationId, selectId) {
  const sel = document.getElementById(selectId);
  if (!sel) {
    return alert("Move dropdown not found. Reopen the batch.");
  }

  const opt = sel.options[sel.selectedIndex];
  if (!opt || !opt.dataset.class) {
    return alert("Please select a target vehicle");
  }

  const targetVehicleClass = opt.dataset.class.trim();
  const targetVehicleNo = (opt.dataset.no || "").trim();

  if (!targetVehicleClass) {
    return alert("Invalid target vehicle");
  }

  const params = new URLSearchParams({
    action: "moveAllocation",
    allocationId,
    targetVehicleClass,
    targetVehicleNo
  });

  fetch(API + "?" + params.toString())
    .then(r => r.json())
    .then(res => {
      if (res.error) throw new Error(res.error);
      allocationCache = {};
      render();
    })
    .catch(err => alert(err.message));
}

function editAlloc(id, current) {
  const n = prompt("Enter new pax count", current);
  if (!n || isNaN(n) || n <= 0) return;

  fetch(API + `?action=editAllocation&allocationId=${id}&newPax=${n}`)
    .then(r => r.json())
    .then(() => {
      allocationCache = {};
      render();
    })
    .catch(e => alert(e.message));
}

const storedTheme = localStorage.getItem("dh-theme");
if (storedTheme === "dark") document.body.classList.add("dark");

function toggleDark() {
  document.body.classList.toggle("dark");
  localStorage.setItem(
    "dh-theme",
    document.body.classList.contains("dark") ? "dark" : "light"
  );
}


    </script>

</body>
</html>