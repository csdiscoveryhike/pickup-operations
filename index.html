<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pickup Operations | Discovery Hike</title>
<link rel="icon" href="favicon.ico" type="image/x-icon">
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
/* ================= THEME VARIABLES ================= */
:root {
  --primary: #00254d;
  --accent: #004b99;
  --danger: #c62828;

  --bg: #f4f6f8;
  --card: #ffffff;
  --border: #e5e7eb;
  --text: #333;
  --muted: #666;

  --safe: #16a34a;
  --warn: #f59e0b;
}

/* DARK MODE */
body.dark {
  --bg: #0f172a;
  --card: #111827;
  --border: #1f2937;
  --text: #e5e7eb;
  --muted: #9ca3af;
}


* { box-sizing: border-box }

body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
               Roboto, Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
  transition: background 0.3s ease, color 0.3s ease;
}

/* Passenger row background */
.batch-sub.passenger {
  display: flex;
  justify-content: space-between;
  gap: 12px;
  background: rgba(0,0,0,0.03);
  padding: 10px;
  border-radius: 10px;
  margin-bottom: 8px;
}

body.dark .batch-sub.passenger {
  background: rgba(255,255,255,0.04);
}

/* ===== HEADER WRAPPER ===== */
.header-wrap {
  display: flex;
  justify-content: center;
  padding: 0;          /* ‚úÖ REMOVE EXTRA SPACE */
  margin-bottom: 26px; /* ‚úÖ SAME AS ADMIN */
}


/* ===== HEADER CARD (ADMIN.html STYLE) ===== */
.header-gradient {
  width: 100%;
  max-width: 820px;

  display: flex;
  flex-direction: column;
  align-items: center;     /* ‚úÖ CENTER EVERYTHING */

  background: linear-gradient(135deg, #00254d, #004b99);
  padding: 28px 18px 30px;   /* ‚úÖ Admin.html vertical rhythm */

  border-radius: 18px;
  box-shadow: 0 10px 24px rgba(0,0,0,0.18);
}


/* ===== LOGO LINK ===== */
.logo-link {
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  text-decoration: none;
}

.logo-top {
  height: 125px;   /* desktop */
  width: auto;
  object-fit: contain;
  opacity: 0.95;
}

@media (max-width: 600px) {
  .logo-top {
    height: 42px;
  }
}


/* ===== HEADER TEXT ===== */
.header-text h1 {
  margin: 0;
  text-align: center;
  font-size: 22px;
  font-weight: 700;
  line-height: 1.25;
  color: #ffffff;
}

.header-text p {
  text-align: center;
  margin: 4px 0 0;
  font-size: 14px;
  opacity: 0.95;
  color: #ffffff;
}

.section-title {
  font-size: 13px;
  font-weight: 700;
  text-transform: uppercase;
  color: var(--muted);
  margin-top: 0;
  margin-bottom: 12px;
  letter-spacing: 0.5px;
}

/* ===== TOP LOADING BAR ===== */
#topLoader {
  position: fixed;
  top: 0;
  left: 0;
  height: 3px;
  width: 0%;
  background: linear-gradient(
    90deg,
    #60a5fa,
    #22c55e
  );
  box-shadow: 0 0 10px rgba(96,165,250,0.6);
  transition: width 0.25s ease, opacity 0.4s ease;
  z-index: 9999;
  opacity: 0;
}

/* ===== LOGO SIZE LOCK ===== */

.progress span {
  display: block;
  height: 100%;
  border-radius: inherit;
  transition: width 0.4s ease;
}


.toggle {
  position: fixed;
  top: 14px;
  right: 14px;
  background: var(--card);
  border-radius: 50px;
  padding: 6px 12px;
  font-size: 12px;
  cursor: pointer;
  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
  z-index: 100;
}

.container {
  max-width:820px;
  margin:auto;
  padding:0 16px 16px;
}

.batch {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 16px;
  margin-bottom: 16px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.08);
  transition: box-shadow 0.2s ease;
}

body.dark .batch {
  box-shadow: 0 10px 24px rgba(0,0,0,0.45);
}


.batch-header {
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:12px;
}

.batch-title {
  font-size:15px;
  font-weight:600;
}

.batch-sub {
  font-size:12px;
  color:var(--muted);
}

.progress {
  height: 8px;
  border-radius: 999px;
  background: var(--border);
  margin-top: 8px;
  overflow: hidden;
}

body.dark .progress {
  background: #020617;
}


.actions {
  margin-top:10px;
}

button,
.btn {
  background: linear-gradient(135deg, #00254d, #004b99);
  color: #fff;
  border: none;
  border-radius: 10px;
  padding: 8px 14px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.12s ease, box-shadow 0.12s ease;
}

button:hover,
.btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 6px 16px rgba(0,0,0,0.25);
}

button:active,
.btn:active {
  transform: scale(0.97);
}

.status {
  font-size: 11px;
  font-weight: 700;
  padding: 4px 10px;
  border-radius: 999px;
}

.DRAFT { background:#e5e7eb; color:#374151 }
.VEHICLES_LOCKED { background:#fef3c7; color:#92400e }
.ALLOCATED { background:#dcfce7; color:#166534 }
.SENT { background:#bbf7d0; color:#065f46 }

body.dark .DRAFT {
  background:#334155;
  color:#e5e7eb;
}


.workspace {
  display:none;
  margin-top:14px;
  border-top:1px dashed var(--border);
  padding-top:14px;
}

.workspace.open { display:block }

.note {
  margin-top:10px;
  padding:10px;
  font-size:12px;
  border-radius:10px;
}
input, select {
  width: 100%;
  padding: 10px 12px;
  border-radius: 10px;
  border: 1px solid var(--border);
  font-size: 13px;
  margin-top: 8px;
  background: var(--card);
  color: var(--text);
}

input:focus, select:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(0,75,153,0.15);
}

body.dark input,
body.dark select {
  background: #020617;
  border-color: #1f2937;
  color: #e5e7eb;
}

.safe { background:#064e3b; color:#d1fae5 }

@media (max-width: 600px) {
  .batch-sub.passenger {
    flex-direction: column;
  }
}

.btn.loading {
  opacity: 0.65;
  pointer-events: none;
}

/* ===== ASSIGNED VEHICLE CARD ===== */
.vehicle-card {
  background: rgba(0,0,0,0.04);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 12px 14px;
  margin-bottom: 10px;
  font-size: 13px;
  line-height: 1.45;
}

body.dark .vehicle-card {
  background: rgba(255,255,255,0.05);
  border-color: #1f2937;
}

.vehicle-title {
  font-weight: 700;
  margin-bottom: 6px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.vehicle-meta {
  font-size: 12px;
  color: var(--muted);
}

body.dark .vehicle-meta {
  color: #9ca3af;
}

/* ===== SKELETON LOADER ===== */
.skeleton {
  position: relative;
  height: 120px;
  overflow: hidden;
}

.skeleton::after {
  content: "";
  position: absolute;
  inset: 0;
  background: linear-gradient(
    90deg,
    var(--border) 25%,
    rgba(255,255,255,0.35) 37%,
    var(--border) 63%
  );
  background-size: 400% 100%;
  animation: shimmer 1.4s infinite;
}

@keyframes shimmer {
  0% { background-position: 100% 0 }
  100% { background-position: -100% 0 }
}

/* Dark mode adjustment */
body.dark .skeleton::after {
  background: linear-gradient(
    90deg,
    #020617 25%,
    rgba(255,255,255,0.08) 37%,
    #020617 63%
  );
}

.workspace {
  opacity: 0;
  transform: translateY(6px);
  transition: opacity 0.25s ease, transform 0.25s ease;
}

.workspace.open {
  opacity: 1;
  transform: translateY(0);
}
/* ===== ADMIN PANEL ===== */
/* ===== ADMIN PANEL GRID (MATCH ADMIN.html) ===== */
.admin-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 14px;
}

/* ===== ADMIN TILE ===== */
.admin-card {
  background: var(--card);
  border-radius: 14px;
  padding: 18px 14px;
  text-align: center;
  cursor: pointer;

  /* square feel */
  min-height: 160px;

  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  padding-top: 22px;
  border: 1px solid transparent;

  box-shadow: 0 6px 14px rgba(0,0,0,0.08);
  transition:
    transform 0.18s ease,
    box-shadow 0.18s ease,
    border-color 0.18s ease;
}

/* hover (desktop) */
.admin-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 14px 24px rgba(0,0,0,0.18);
}

/* ===== DARK MODE HOVER GLOW (ADMIN.html STYLE) ===== */
@media (hover: hover) {
  body.dark .admin-card:hover {
    box-shadow:
      0 0 0 1px rgba(56, 189, 248, 0.25),
      0 16px 28px rgba(0,0,0,0.6);
  }
}
/* ===== SELECTED TILE ===== */
.admin-card.selected {
  border-color: var(--accent);
}

/* dark mode selected glow */
body.dark .admin-card.selected {
  border-color: #38bdf8;
  box-shadow:
    0 0 0 1px rgba(56,189,248,0.35),
    0 12px 26px rgba(0,0,0,0.6);
}

.admin-card span {
  display: block;
  margin-top: 6px;
  font-size: 12px;
  color: var(--muted);
  font-weight: 400;
}


.hidden {
  display: none;
}

/* ===== MOBILE SAFETY (MATCH ADMIN.html) ===== */
@media (hover: none) {
  .admin-card {
    transform: none !important;
    box-shadow: 0 8px 18px rgba(0,0,0,0.25) !important;
  }

  body.dark .admin-card {
    box-shadow: 0 8px 18px rgba(0,0,0,0.45) !important;
  }

  .admin-card:active {
    transform: scale(0.97);
    box-shadow: 0 6px 12px rgba(0,0,0,0.35);
  }
}

/* ===== ADMIN CARD CONTENT (MATCH ADMIN.html) ===== */

.card-icon {
  font-size: 28px;           /* BIG emoji */
  margin-bottom: 10px;
  line-height: 1;
}

.card-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--primary);
}

body.dark .card-title {
  color: #f1f5f9;            /* same as Admin.html */
}
body.dark .card-icon {
  filter: brightness(1.1);
}

.card-desc {
  font-size: 12px;
  color: var(--muted);
  margin-top: 4px;
  line-height: 1.4;
}

/* ===== PAX PROGRESS ===== */
.pax-progress {
  margin: 10px 0 16px;
}

.pax-progress-label {
  font-size: 11px;
  color: var(--muted);
  margin-bottom: 6px;
}

/* ===== ALLOCATION MILESTONES ===== */
.milestones {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin: 12px 0 16px;
  font-size: 12px;
}

.milestone {
  display: flex;
  align-items: center;
  gap: 6px;
  color: var(--muted);
  font-weight: 600;
}

.milestone.done {
  color: #16a34a;
}

.milestone.active {
  color: #2563eb;
}

.milestone-line {
  flex: 1;
  height: 2px;
  background: var(--border);
  margin: 0 8px;
}

.milestone-line.done {
  background: #16a34a;
}


/* ================= FOOTER ================= */
.footer {
  margin-top: 40px;
  padding: 18px;
  text-align: center;
  font-size: 12px;
  color: #d0e4ff;
  background: linear-gradient(135deg, #00254d, #004b99);
  border-radius: 14px;
}

.session-bar {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 14px;
  font-size: 12px;
}


</style>
</head>

<body>
  <div id="topLoader"></div>

<div class="toggle" onclick="toggleDark()">üåô / ‚òÄÔ∏è</div>

<header class="header-wrap">
  <div class="header-gradient">
    <a href="https://discoveryhike.in"
       target="_blank"
       class="logo-link"
       title="Go to Discovery Hike website">

      <img src="https://i.imgur.com/40sl7Sv.png"
           alt="Discovery Hike"
           class="logo-top">
    </a>

    <div class="header-text">
      <h1>Discovery Hike ‚Äì Pickup Operations</h1>
      <p>Internal transport & allocation system</p>
    </div>
  </div>
</header>





<div class="container">

  <!-- ================= ADMIN PANEL ================= -->
 <section id="admin-panel">
  <div class="section-title">
  Pickup & Transport Operations Panel
</div>

  <div class="admin-grid">

    <div class="admin-card" onclick="openModule('pickup-workspace', this)">
      <div class="card-icon">üöê</div>
      <div class="card-title">Pickup Workspace</div>
      <div class="card-desc">Active batches & passenger allocation</div>
    </div>

    <div class="admin-card" onclick="openModule('allocation-dashboard', this)">
      <div class="card-icon">üìä</div>
      <div class="card-title">Allocation Dashboard</div>
      <div class="card-desc">Past & sent pickup allocations</div>
    </div>

    <div class="admin-card" onclick="openModule('vehicle-classes', this)">
      <div class="card-icon">‚öôÔ∏è</div>
      <div class="card-title">Vehicle Classes</div>
      <div class="card-desc">Manage vehicle types & capacity</div>
    </div>

    <div class="admin-card" onclick="openModule('pickup-points', this)">
      <div class="card-icon">üìç</div>
      <div class="card-title">Pickup Points</div>
      <div class="card-desc">Pickup names & map locations</div>
    </div>

    <div class="admin-card" onclick="openModule('driver-directory', this)">
      <div class="card-icon">üë®‚Äç‚úàÔ∏è</div>
      <div class="card-title">Driver Directory</div>
      <div class="card-desc">Drivers, phones & availability</div>
    </div>
  </div>
</section>

  <!-- ================= PICKUP WORKSPACE ================= -->
  <section id="pickup-workspace" class="module hidden">
    <button class="btn" onclick="goHome()">‚Üê Back</button>

    <!-- YOUR EXISTING WORKSPACE (UNCHANGED) -->
    <div id="list">
      <div class="batch skeleton"></div>
      <div class="batch skeleton"></div>
      <div class="batch skeleton"></div>
    </div>
  </section>

  <!-- ================= OTHER MODULES (PLACEHOLDERS) ================= -->
  <section id="allocation-dashboard" class="module hidden">
    <button class="btn" onclick="goHome()">‚Üê Back</button>
    <h3>Allocation Dashboard</h3>
    <div class="batch-sub">Read-only past allocations will appear here.</div>
  </section>

  <section id="vehicle-classes" class="module hidden">
    <button class="btn" onclick="goHome()">‚Üê Back</button>
    <h3>Vehicle Classes</h3>
    <div class="batch-sub">Manage vehicle capacity types.</div>
  </section>

  <section id="pickup-points" class="module hidden">
    <button class="btn" onclick="goHome()">‚Üê Back</button>
    <h3>Pickup Points</h3>
    <div class="batch-sub">Pickup names & map links.</div>
  </section>

  <section id="driver-directory" class="module hidden">
    <button class="btn" onclick="goHome()">‚Üê Back</button>
    <h3>Driver Directory</h3>
    <div class="batch-sub">Drivers & phone numbers.</div>
  </section>

  <!-- ================= FOOTER ================= -->
  <footer class="footer">
    <div class="session-bar">
      <span>Pickup Operations Module</span>
    </div>

    <div style="margin-top:10px;">
      ¬© Discovery Hike ‚Ä¢ Internal Operations System
    </div>

    <p style="opacity:0.85;font-size:11px;line-height:1.4;margin-top:8px;">
      Authorized internal use only.<br>
      Part of Discovery Hike Admin Platform.
    </p>
  </footer>
  

</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbyDkebftew8h2PBHpizEnvlSa9bBITn9TCQhjZmrtPkVDEyFNvB2xDU0C5povyzRDgE/exec";

let batches = [];
let vehicles = [];
let assignmentsCache = {};
let allocationCache = {};
const loader = document.getElementById("topLoader");
let loadingCount = 0;
let openBatchId = null;

function startLoading() {
  if (loadingCount === 0) {
    loader.style.opacity = "1";
    loader.style.width = "30%";
  }
  loadingCount++;
}

function endLoading() {
  loadingCount = Math.max(loadingCount - 1, 0);

  if (loadingCount === 0) {
    loader.style.width = "100%";
    setTimeout(() => {
      loader.style.opacity = "0";
      loader.style.width = "0%";
    }, 400);
  }
}

function safeEndLoading() {
  try { endLoading(); } catch(e) {}
}

function loadPickupWorkspace() {
  startLoading();

  Promise.all([
    fetch(API + "?action=batches").then(r => r.json()),
    fetch(API + "?action=vehicles").then(r => r.json())
  ])
  .then(([b, v]) => {
    batches = b;
    vehicles = v;
    render();
    endLoading();
  })
  .catch(err => {
    safeEndLoading();
    alert("Failed to load pickup data");
  });
}

// DEFAULT ENTRY
openModule("admin-panel");


/* ---------- RENDER ---------- */
function render() {
  const el = document.getElementById("list");
  el.innerHTML = "";

  batches.forEach(b => {
    const pct = b.totalPax
      ? Math.min(100, Math.round((b.assignedCapacity / b.totalPax) * 100))
      : 0;

    const barColor =
      b.assignedCapacity < b.totalPax ? "#f59e0b" : "#22c55e";

    el.innerHTML += `
      <div class="batch" id="batch-${domId(b.batchId)}">
        <div class="batch-header">
          <div>
            <div class="batch-title">${b.trekName}</div>
            <div class="batch-sub">${b.trekDate}</div>
          </div>
          <span class="status ${b.status}">${b.status}</span>
        </div>

        <div class="batch-sub">
          Pax: <b>${b.totalPax}</b> ‚Ä¢ Assigned: <b>${b.assignedCapacity}</b>
        </div>

        <div class="milestones">
  <div class="milestone ${b.status !== 'DRAFT' ? 'done' : 'active'}">
    üßæ Created ${b.status !== 'DRAFT' ? '‚úÖ' : '‚ùå'}
  </div>

  <div class="milestone-line ${b.status !== 'DRAFT' ? 'done' : ''}"></div>

  <div class="milestone ${
    b.status === 'VEHICLES_LOCKED' || b.status === 'ALLOCATED' || b.status === 'SENT'
      ? 'done'
      : b.status === 'DRAFT'
      ? ''
      : 'active'
  }">
    üöê Vehicles Locked ${
      b.status === 'VEHICLES_LOCKED' || b.status === 'ALLOCATED' || b.status === 'SENT'
        ? '‚úÖ'
        : '‚ùå'
    }
  </div>

  <div class="milestone-line ${
    b.status === 'ALLOCATED' || b.status === 'SENT' ? 'done' : ''
  }"></div>

  <div class="milestone ${
    b.status === 'ALLOCATED' || b.status === 'SENT'
      ? 'done'
      : b.status === 'VEHICLES_LOCKED'
      ? 'active'
      : ''
  }">
    üë• Allocated ${
      b.status === 'ALLOCATED' || b.status === 'SENT'
        ? '‚úÖ'
        : '‚ùå'
    }
  </div>

  <div class="milestone-line ${
    b.status === 'SENT' ? 'done' : ''
  }"></div>

  <div class="milestone ${b.status === 'SENT' ? 'done' : ''}">
    üì§ Sent ${b.status === 'SENT' ? '‚úÖ' : '‚ùå'}
  </div>
</div>


        <div class="actions">
          <button class="btn" onclick="toggleWorkspace('${b.batchId}')"
>
            Manage Batch
          </button>
        </div>

        <div class="workspace" id="ws-${domId(b.batchId)}"></div>
      </div>
    `;
  });


    // ‚úÖ restore previously open workspace after re-render
  if (openBatchId) {
    requestAnimationFrame(() => {
      toggleWorkspace(openBatchId);
    });
  }

}

/* ---------- WORKSPACE ---------- */
function workspaceHTML(b) {
  
  const assigns = (assignmentsCache[b.batchId] || [])
    .filter(a => a.status === "ACTIVE");

  const allocs = allocationCache[b.batchId] || [];
  const editable = b.status === "ALLOCATED";

  // üîí Vehicle lock (NOT email sent)
  const locked = b.status !== "DRAFT";
  const pct = b.totalPax
  ? Math.min(100, Math.round((b.assignedCapacity / b.totalPax) * 100))
  : 0;

const barColor =
  b.assignedCapacity < b.totalPax ? "#f59e0b" : "#22c55e";


  return `
    <h4>Assigned Vehicles</h4>
    <div class="pax-progress">
  <div class="pax-progress-label">
    Passenger assignment progress
    (<b>${b.assignedCapacity}</b> / <b>${b.totalPax}</b> pax)
  </div>

  <div class="progress">
    <span style="width:${pct}%;background:${barColor}"></span>
  </div>
</div>

    ${assigns.length
      ? assigns.map(a => `
  <div class="vehicle-card">
    <div class="vehicle-title">
      üöê ${a.vehicleClass} ‚Ä¢ ${a.assignedPax} pax
    </div>

    <div class="vehicle-meta">
      <div><b>Vehicle:</b> ${a.vehicleNo || "‚Äî"}</div>
      <div><b>Driver:</b> ${a.driverName || "‚Äî"} (${a.driverPhone || "‚Äî"})</div>
      <div><b>Pickup:</b> ${a.pickupPoint || "‚Äî"} @ ${formatTime12h(a.pickupTime)}</div>
    </div>
  </div>
`)
.join("")
      : "<div class='batch-sub'>No vehicles assigned</div>"
    }

    ${b.status === "VEHICLES_LOCKED" ? `
  <div class="actions">
    <button class="btn" onclick="allocatePassengers('${b.batchId}', this)"
>
      üë• Allocate Passengers
    </button>
  </div>
  <div class="note">
    Allocation will run once and cannot be re-run automatically.
  </div>
` : ""}



    ${!locked ? `
      <div class="actions">
        <button class="btn" onclick="lockVehicles('${b.batchId}', this)">
          üîí Lock Vehicles
        </button>
      </div>
    ` : `
      ${b.status === "VEHICLES_LOCKED" ? `
  <div class="note safe">
    Vehicles locked. Passenger allocation enabled.
  </div>
` : ""}

    `}

    ${b.status === "ALLOCATED" ? `
  <hr style="border-color:#1f2937;margin:10px 0">
  <div class="note safe">
    Vehicles are locked. Passenger allocation completed.
  </div>
` : ``}


   ${b.status === "ALLOCATED"
 ? `
  <h4>Passenger Allocation</h4>
<div id="swap-bar-${domId(b.batchId)}" style="display:none;margin:6px 0">
  <button class="btn"
  onclick="swapSelected('${b.batchId}', this)">
    üîÅ Swap Selected Passengers
  </button>
</div>

  ${allocs.length
    ? allocs.map(a => `
      <div class="batch-sub passenger">


        
        <div>
          ${editable ? `
<div style="display:flex;align-items:center;gap:6px;margin-bottom:4px">
  <input type="checkbox"
  class="swap-check"
  value="${a.id}"
  onchange="updateSwapBar('${b.batchId}', this)">
  <label style="font-size:11px;color:#9ca3af">
    Select for swap
  </label>
</div>
` : ""}



          üë§ <b>${a.email}</b><br>
          Pax: ${a.pax}<br>
          üöê ${a.vehicleClass} ${a.vehicleNo || ""}<br>
          üìç ${a.pickupPoint || "‚Äî"} @ ${formatTime12h(a.pickupTime) || "‚Äî"}<br>
          üë®‚Äç‚úàÔ∏è ${a.driverName || "‚Äî"} (${a.driverPhone || "‚Äî"})
        </div>

        <div style="display:flex;flex-direction:column;gap:6px">
  ${editable ? `
  <button class="btn"
    onclick="editAlloc('${a.id}', ${a.pax})">
    Edit
  </button>

  <button class="btn"
    onclick="cancelAlloc('${a.id}')">
    Cancel
  </button>
  ` : ""}

  ${editable ? `
  <select id="mv-${a.id}" onchange="this.nextElementSibling.disabled = !this.value">
    <option value="">Move to vehicle‚Ä¶</option>
    ${assigns.map(v => `
     <option 
  data-class="${v.vehicleClass}" 
  data-no="${v.vehicleNo || ""}">
  ${v.vehicleClass} ${v.vehicleNo || ""}
</option>

    `).join("")}
  </select>

  <button class="btn" disabled
    onclick="handleMove('${a.id}', 'mv-${a.id}')">
    Move
  </button>
  ` : ""}
</div>

      </div>
    `).join("")
    : "<div class='batch-sub'>No passengers allocated yet</div>"
  }
` : `
`}


    ${b.status === "ALLOCATED" ? "" : `
<hr style="border-color:#1f2937;margin:10px 0">
`}
<h4>Add Vehicle</h4>


    ${locked ? `
      <div class="note" style="background:#7c2d12;color:#fee2e2">
        Vehicles are locked. Cannot add or edit vehicles.
      </div>
    ` : `
      <select id="vc-${domId(b.batchId)}">
        <option value="">Select vehicle</option>
        ${vehicles.map(v =>
          `<option value="${v.class}">
            ${v.class} (${v.capacity})
          </option>`
        ).join("")}
      </select>

      <input placeholder="Vehicle Number" id="vn-${domId(b.batchId)}">
      <input placeholder="Driver Name" id="dn-${domId(b.batchId)}">
      <input placeholder="Driver Phone" id="dp-${domId(b.batchId)}">
      <input placeholder="Pickup Point" id="pp-${domId(b.batchId)}">
      <input type="time" id="pt-${domId(b.batchId)}">
      <div class="actions">
        <button class="btn" onclick="save('${b.batchId}', this)">
          Save Assignment
        </button>
      </div>

      <div class="note safe">
        Assigned pax is auto-calculated from vehicle capacity.
      </div>
    `}
  `;
}

/* ---------- TOGGLE ---------- */
function toggleWorkspace(batchId) {
  const safeId = domId(batchId);
  const ws = document.getElementById(`ws-${safeId}`);
  if (!ws) return;

  const isOpen = ws.classList.contains("open");

  // close all open workspaces
  document.querySelectorAll(".workspace.open").forEach(el => {
    el.classList.remove("open");
    el.innerHTML = "";
  });

  // ‚ùå user clicked to close ‚Üí forget open batch
  if (isOpen) {
    openBatchId = null;   // ‚úÖ IMPORTANT
    return;
  }

  // ‚úÖ user opened this batch ‚Üí remember it
  openBatchId = batchId;

  ws.classList.add("open");
  ws.innerHTML = "<div class='batch-sub'>Loading data‚Ä¶</div>";

  const batch = batches.find(b => b.batchId === batchId);
  if (!batch) return alert("Batch not found");

  const shouldLoadAllocations =
    ["ALLOCATED", "SENT"].includes(batch.status);

  Promise.all([
    assignmentsCache[batchId]
      ? Promise.resolve(assignmentsCache[batchId])
      : fetch(API + "?action=assignments&batchId=" + encodeURIComponent(batchId))
          .then(r => r.json())
          .then(d => (assignmentsCache[batchId] = d)),

    shouldLoadAllocations
      ? (allocationCache[batchId]
          ? Promise.resolve(allocationCache[batchId])
          : fetch(API + "?action=allocations&batchId=" + encodeURIComponent(batchId))
              .then(r => r.json())
              .then(d => (allocationCache[batchId] = d)))
      : Promise.resolve([])
  ])
  .then(() => {
    ws.innerHTML = workspaceHTML(batch);
  });
}

function allocatePassengers(batchId, btn) {
  if (!confirm("Allocate passengers now? This can only be done once.")) return;
  
  btn.classList.add("loading");
startLoading(); 
loader.style.width = "60%";
  btn.disabled = true;
  btn.innerText = "Allocating‚Ä¶";

  fetch(API + `?action=allocatePassengers&batchId=${encodeURIComponent(batchId)}`)
    .then(r => r.json())
    .then(res => {
      if (res.error) throw new Error(res.error);

      allocationCache = {};
      return fetch(API + "?action=batches").then(r => r.json());
    })
    .then(b => {
      batches = b;
      render();
      requestAnimationFrame(() => toggleWorkspace(batchId));
      btn.classList.remove("loading"); 
      endLoading(); 
    })
    .catch(err => {
      safeEndLoading();
      btn.classList.remove("loading");
      alert(err.message);
      btn.disabled = false;
      btn.innerText = "üë• Allocate Passengers";
    });
}

function formatTime12h(value) {
  if (!value) return "‚Äî";

  const d = new Date(value);
  if (isNaN(d)) return "‚Äî";

  let hours = d.getHours();
  const minutes = d.getMinutes().toString().padStart(2, "0");
  const ampm = hours >= 12 ? "PM" : "AM";

  hours = hours % 12 || 12;

  return `${hours}:${minutes} ${ampm}`;
}

/* ---------- SAVE ASSIGNMENT ---------- */
function save(batchId, btn) {
  const safeId = domId(batchId);
  btn.classList.add("loading");
  btn.disabled = true;
  btn.innerText = "Saving‚Ä¶";
  startLoading(); 
  const vc = document.getElementById(`vc-${safeId}`).value;
  if (!vc) {
    safeEndLoading();
     btn.classList.remove("loading");
    btn.disabled = false;
    btn.innerText = "Save Assignment";
    return alert("Select vehicle class");
  }

  const params = new URLSearchParams({
    action: "addAssignment",
    batchId: batchId,
    vehicleClass: vc,
   vehicleNo: document.getElementById(`vn-${safeId}`).value || "",
    driverName: document.getElementById(`dn-${safeId}`).value || "",
    driverPhone: document.getElementById(`dp-${safeId}`).value || "",
    pickupPoint: document.getElementById(`pp-${safeId}`).value || "",
    pickupTime: document.getElementById(`pt-${safeId}`).value || ""
  });

  fetch(API + "?" + params.toString())
    .then(r => r.json())
    .then(res => {
      if (res.error) throw new Error(res.error);

      assignmentsCache[batchId] = null;
      allocationCache[batchId] = null;

      return Promise.all([
        fetch(API + "?action=assignments&batchId=" + batchId).then(r => r.json()),
        fetch(API + "?action=batches").then(r => r.json())
      ]);
    })
    .then(([a, b]) => {
  assignmentsCache[batchId] = a;
  allocationCache[batchId] = []; // reset safely
  batches = b;

    btn.classList.remove("loading");

      btn.disabled = false;
      btn.innerText = "Save Assignment";

      render();

// ensure DOM is painted first
requestAnimationFrame(() => {
  toggleWorkspace(batchId);
});
endLoading(); 

    })
    .catch(err => {
     safeEndLoading();
      btn.classList.remove("loading");  
      btn.disabled = false;
      btn.innerText = "Save Assignment";
      alert("Failed to save assignment: " + err.message);
      console.error(err);
    });
}
  
function lockVehicles(batchId, btn) {
  if (!confirm("Lock vehicles? You won‚Äôt be able to edit them later.")) return;
  btn.classList.add("loading");
startLoading();    
  btn.disabled = true;
  btn.innerText = "Locking‚Ä¶";

  fetch(API + "?action=lockVehicles&batchId=" + encodeURIComponent(batchId))
    .then(r => r.json())
    .then(res => {
      if (res.error) throw new Error(res.error);

      return fetch(API + "?action=batches").then(r => r.json());
    })
    .then(b => {
      batches = b;
      render();
      setTimeout(() => toggleWorkspace(batchId), 0);
      btn.classList.remove("loading"); 
       endLoading();  
    })
    .catch(err => {
       safeEndLoading();
       btn.classList.remove("loading"); 
      alert(err.message);
      btn.disabled = false;
      btn.innerText = "üîí Lock Vehicles";
    });
}

function updateSwapBar(batchId, checkbox) {
  const safeId = domId(batchId);

  const checks = [
    ...document.querySelectorAll(`#ws-${safeId} .swap-check`)
  ];

  const checked = checks.filter(c => c.checked);

  // prevent selecting more than 2
  if (checked.length > 2) {
    checkbox.checked = false;
    alert("You can select only 2 passengers to swap");
    return;
  }

  const bar = document.getElementById(`swap-bar-${safeId}`);
  if (!bar) return;

  bar.style.display = checked.length === 2 ? "block" : "none";
}

function swapSelected(batchId, btn) {
  const safeId = domId(batchId);

  const ids = [...document.querySelectorAll(
    `#ws-${safeId} .swap-check:checked`
  )].map(c => c.value);

  if (ids.length !== 2) {
    alert("Select exactly 2 passengers to swap");
    return;
  }

  if (!confirm("Swap these two passengers?")) return;

  btn.classList.add("loading");
  startLoading();

  const params = new URLSearchParams({
    action: "swapAllocations",
    allocationIdA: ids[0],
    allocationIdB: ids[1]
  });

  fetch(API + "?" + params.toString())
    .then(r => r.json())
    .then(res => {
      if (res.error) throw new Error(res.error);
      allocationCache = {};
      render();
      btn.classList.remove("loading");
      endLoading();
    })
    .catch(err => {
      btn.classList.remove("loading");
      safeEndLoading();
      alert(err.message);
    });
}

function domId(id) {
  return id.replace(/[^a-zA-Z0-9_-]/g, "_");
}


function cancelAlloc(id) {
  if (!confirm("Cancel this allocation?")) return;

  fetch(API + "?action=cancelAllocation&allocationId=" + encodeURIComponent(id))
    .then(r => r.json())
    .then(() => {
      allocationCache = {};
      render();
    })
    .catch(e => alert(e.message));
}

function handleMove(allocationId, selectId) {
  const sel = document.getElementById(selectId);
  if (!sel) {
    return alert("Move dropdown not found. Reopen the batch.");
  }

  const opt = sel.options[sel.selectedIndex];
  if (!opt || !opt.dataset.class) {
    return alert("Please select a target vehicle");
  }

  const targetVehicleClass = opt.dataset.class.trim();
  const targetVehicleNo = (opt.dataset.no || "").trim();

  if (!targetVehicleClass) {
    return alert("Invalid target vehicle");
  }

  const params = new URLSearchParams({
    action: "moveAllocation",
    allocationId,
    targetVehicleClass,
    targetVehicleNo
  });

  fetch(API + "?" + params.toString())
    .then(r => r.json())
    .then(res => {
      if (res.error) throw new Error(res.error);
      allocationCache = {};
      render();
    })
    .catch(err => alert(err.message));
}

function editAlloc(id, current) {
  const n = prompt("Enter new pax count", current);
  if (!n || isNaN(n) || n <= 0) return;

  fetch(API + `?action=editAllocation&allocationId=${id}&newPax=${n}`)
    .then(r => r.json())
    .then(() => {
      allocationCache = {};
      render();
    })
    .catch(e => alert(e.message));
}

const storedTheme = localStorage.getItem("dh-theme");
if (storedTheme === "dark") document.body.classList.add("dark");

function toggleDark() {
  document.body.classList.toggle("dark");
  localStorage.setItem(
    "dh-theme",
    document.body.classList.contains("dark") ? "dark" : "light"
  );
}

function openModule(id, cardEl) {
  // hide all modules
  document.querySelectorAll(".container > section").forEach(s => {
    s.classList.add("hidden");
  });

  // remove previous selection
  document.querySelectorAll(".admin-card").forEach(c => {
    c.classList.remove("selected");
  });

  // mark selected card
  if (cardEl) {
    cardEl.classList.add("selected");
  }

  // show module
  document.getElementById(id).classList.remove("hidden");

  if (id === "pickup-workspace" && batches.length === 0) {
    loadPickupWorkspace();
  }
}


function goHome() {
  openModule("admin-panel");
}


    </script>

</body>
</html>