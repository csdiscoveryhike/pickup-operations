<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pickup Operations | Discovery Hike</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root {
  --bg:#0f172a;
  --card:#111827;
  --border:#1f2937;
  --text:#e5e7eb;
  --muted:#9ca3af;
  --primary:#2563eb;
  --safe:#16a34a;
  --warn:#f59e0b;
}

* { box-sizing: border-box }

body {
  margin:0;
  font-family: system-ui, sans-serif;
  background: var(--bg);
  color: var(--text);
}

header {
  padding:16px 20px;
  border-bottom:1px solid var(--border);
  background:#020617;
}

header h1 {
  font-size:16px;
  margin:0;
}

.container {
  max-width:1000px;
  margin:auto;
  padding:16px;
}

.batch {
  background:var(--card);
  border:1px solid var(--border);
  border-radius:14px;
  padding:14px;
  margin-bottom:14px;
}

.batch-header {
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:12px;
}

.batch-title {
  font-size:15px;
  font-weight:600;
}

.batch-sub {
  font-size:12px;
  color:var(--muted);
}

.status {
  font-size:11px;
  font-weight:700;
  padding:4px 10px;
  border-radius:999px;
}

.DRAFT { background:#334155; color:#e5e7eb }
.VEHICLES_LOCKED { background:#fef3c7; color:#92400e }
.ALLOCATED { background:#dcfce7; color:#166534 }
.SENT { background:#bbf7d0; color:#065f46 }


.progress {
  height:8px;
  border-radius:999px;
  background:#020617;
  margin-top:8px;
  overflow:hidden;
}

.progress span {
  display:block;
  height:100%;
  background:linear-gradient(90deg,#2563eb,#22c55e);
}

.actions {
  margin-top:10px;
}

button {
  border:none;
  border-radius:8px;
  padding:8px 12px;
  font-size:13px;
  font-weight:600;
  cursor:pointer;
}

.btn {
  background:#1f2937;
  color:#e5e7eb;
}

.workspace {
  display:none;
  margin-top:14px;
  border-top:1px dashed var(--border);
  padding-top:14px;
}

.workspace.open { display:block }

.note {
  margin-top:10px;
  padding:10px;
  font-size:12px;
  border-radius:10px;
}

.safe { background:#064e3b; color:#d1fae5 }
</style>
</head>

<body>

<header>
  <h1>Discovery Hike ‚Äì Pickup Operations</h1>
</header>

<div class="container">
  <div id="list">Loading pickup batches‚Ä¶</div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbznOvHF4WaFh_jExrVjHE7IFPpYByPOwHA9o8Z7WIAN6nQPklE_irxX_NjVGVuE9Hoj/exec";

let batches = [];
let vehicles = [];
let assignmentsCache = {};
let allocationCache = {};
/* ---------- INITIAL LOAD ---------- */
Promise.all([
  fetch(API + "?action=batches").then(r => r.json()),
  fetch(API + "?action=vehicles").then(r => r.json())
])
.then(([b, v]) => {
  batches = b;
  vehicles = v;
  render();
})
.catch(err => {
  alert("Failed to load pickup data");
  console.error(err);
});

/* ---------- RENDER ---------- */
function render() {
  const el = document.getElementById("list");
  el.innerHTML = "";

  batches.forEach(b => {
    const pct = b.totalPax
      ? Math.min(100, Math.round((b.assignedCapacity / b.totalPax) * 100))
      : 0;

    const barColor =
      b.assignedCapacity < b.totalPax ? "#f59e0b" : "#22c55e";

    el.innerHTML += `
      <div class="batch" id="batch-${b.batchId}">
        <div class="batch-header">
          <div>
            <div class="batch-title">${b.trekName}</div>
            <div class="batch-sub">${b.trekDate}</div>
          </div>
          <span class="status ${b.status}">${b.status}</span>
        </div>

        <div class="batch-sub">
          Pax: <b>${b.totalPax}</b> ‚Ä¢ Assigned: <b>${b.assignedCapacity}</b>
        </div>

        <div class="progress">
          <span style="width:${pct}%;background:${barColor}"></span>
        </div>

        <div class="actions">
          <button class="btn" onclick="toggleWorkspace('${b.batchId}')">
            Manage Batch
          </button>
        </div>

        <div class="workspace" id="ws-${b.batchId}"></div>
      </div>
    `;
  });
}

/* ---------- WORKSPACE ---------- */
function workspaceHTML(b) {
  const assigns = (assignmentsCache[b.batchId] || [])
    .filter(a => a.status === "ACTIVE");

  const allocs = allocationCache[b.batchId] || [];

  // üîí Vehicle lock (NOT email sent)
  const locked = b.status !== "DRAFT";

  return `
    <h4>Assigned Vehicles</h4>

    ${assigns.length
      ? assigns.map(a => `
        <div class="batch-sub">
          üöê <b>${a.vehicleClass}</b> (${a.assignedPax} pax)<br>
          Vehicle No: ${a.vehicleNo || "‚Äî"}<br>
          Driver: ${a.driverName || "‚Äî"} (${a.driverPhone || "‚Äî"})<br>
          Pickup: ${a.pickupPoint || "‚Äî"} @ ${a.pickupTime || "‚Äî"}
        </div>
      `).join("")
      : "<div class='batch-sub'>No vehicles assigned</div>"
    }

    ${b.status === "VEHICLES_LOCKED" ? `
  <div class="actions">
    <button class="btn" onclick="allocatePassengers('${b.batchId}', this)">
      üë• Allocate Passengers
    </button>
  </div>
  <div class="note">
    Allocation will run once and cannot be re-run automatically.
  </div>
` : ""}



    ${!locked ? `
      <div class="actions">
        <button class="btn" onclick="lockVehicles('${b.batchId}', this)">
          üîí Lock Vehicles
        </button>
      </div>
      <div class="note">
        Lock vehicles before passenger allocation.
      </div>
    ` : `
      ${b.status === "VEHICLES_LOCKED" ? `
  <div class="note safe">
    Vehicles locked. Passenger allocation enabled.
  </div>
` : ""}

    `}

    <hr style="border-color:#1f2937;margin:10px 0">
${b.status === "ALLOCATED" ? `
  <div class="note safe">
    Vehicles are locked. Passenger allocation completed.
  </div>
` : ""}

   ${["ALLOCATED", "SENT"].includes(b.status) ? `
  <h4>Passenger Allocation</h4>

  ${allocs.length
    ? allocs.map(a => `
      <div class="batch-sub"
        style="display:flex;justify-content:space-between;gap:10px">

        <div>
          üë§ <b>${a.email}</b><br>
          Pax: ${a.pax}<br>
          üöê ${a.vehicleClass} ${a.vehicleNo || ""}<br>
          üìç ${a.pickupPoint || "‚Äî"} @ ${a.pickupTime || "‚Äî"}<br>
          üë®‚Äç‚úàÔ∏è ${a.driverName || "‚Äî"} (${a.driverPhone || "‚Äî"})
        </div>

        <div>
          <button class="btn"
            onclick="editAlloc('${a.id}', ${a.pax})">
            Edit
          </button>
          <button class="btn"
            onclick="cancelAlloc('${a.id}')">
            Cancel
          </button>
        </div>
      </div>
    `).join("")
    : "<div class='batch-sub'>No passengers allocated yet</div>"
  }
` : `
  <div class="note">
    Passenger allocation will appear after vehicles are locked.
  </div>
`}


    <hr style="border-color:#1f2937;margin:10px 0">

    <h4>Add Vehicle</h4>

    ${locked ? `
      <div class="note" style="background:#7c2d12;color:#fee2e2">
        Vehicles are locked. Cannot add or edit vehicles.
      </div>
    ` : `
      <select id="vc-${b.batchId}">
        <option value="">Select vehicle</option>
        ${vehicles.map(v =>
          `<option value="${v.class}">
            ${v.class} (${v.capacity})
          </option>`
        ).join("")}
      </select>

      <input placeholder="Vehicle Number" id="vn-${b.batchId}">
      <input placeholder="Driver Name" id="dn-${b.batchId}">
      <input placeholder="Driver Phone" id="dp-${b.batchId}">
      <input placeholder="Pickup Point" id="pp-${b.batchId}">
      <input type="time" id="pt-${b.batchId}">

      <div class="actions">
        <button class="btn" onclick="save('${b.batchId}', this)">
          Save Assignment
        </button>
      </div>

      <div class="note safe">
        Assigned pax is auto-calculated from vehicle capacity.
      </div>
    `}
  `;
}

/* ---------- TOGGLE ---------- */
function toggleWorkspace(batchId) {
  const ws = document.getElementById(`ws-${batchId}`);
  const isOpen = ws.classList.contains("open");

  document.querySelectorAll(".workspace.open").forEach(el => {
    el.classList.remove("open");
    el.innerHTML = "";
  });

  if (isOpen) return;

  ws.classList.add("open");
  ws.innerHTML = "<div class='batch-sub'>Loading data‚Ä¶</div>";

 const batch = batches.find(b => b.batchId === batchId);
const shouldLoadAllocations =
  ["ALLOCATED", "SENT"].includes(batch.status);

Promise.all([
  assignmentsCache[batchId]
    ? Promise.resolve(assignmentsCache[batchId])
    : fetch(API + "?action=assignments&batchId=" + encodeURIComponent(batchId))
        .then(r => r.json())
        .then(d => (assignmentsCache[batchId] = d)),

  shouldLoadAllocations
    ? (allocationCache[batchId]
        ? Promise.resolve(allocationCache[batchId])
        : fetch(API + "?action=allocations&batchId=" + encodeURIComponent(batchId))
            .then(r => r.json())
            .then(d => (allocationCache[batchId] = d)))
    : Promise.resolve([])
])

  .then(() => {
    ws.innerHTML = workspaceHTML(
      batches.find(b => b.batchId === batchId)
    );
  })
  .catch(err => {
    console.error(err);
    ws.innerHTML = "<div class='batch-sub'>Failed to load batch data</div>";
  });
}

function allocatePassengers(batchId, btn) {
  if (!confirm("Allocate passengers now? This can only be done once.")) return;

  btn.disabled = true;
  btn.innerText = "Allocating‚Ä¶";

  fetch(API + `?action=allocatePassengers&batchId=${encodeURIComponent(batchId)}`)
    .then(r => r.json())
    .then(res => {
      if (res.error) throw new Error(res.error);

      allocationCache = {};
      return fetch(API + "?action=batches").then(r => r.json());
    })
    .then(b => {
      batches = b;
      render();
      requestAnimationFrame(() => toggleWorkspace(batchId));
    })
    .catch(err => {
      alert(err.message);
      btn.disabled = false;
      btn.innerText = "üë• Allocate Passengers";
    });
}

/* ---------- SAVE ASSIGNMENT ---------- */
function save(batchId, btn) {
  btn.disabled = true;
  btn.innerText = "Saving‚Ä¶";

  const vc = document.getElementById(`vc-${batchId}`).value;
  if (!vc) {
    btn.disabled = false;
    btn.innerText = "Save Assignment";
    return alert("Select vehicle class");
  }

  const params = new URLSearchParams({
    action: "addAssignment",
    batchId: batchId,
    vehicleClass: vc,
    vehicleNo: document.getElementById(`vn-${batchId}`).value || "",
    driverName: document.getElementById(`dn-${batchId}`).value || "",
    driverPhone: document.getElementById(`dp-${batchId}`).value || "",
    pickupPoint: document.getElementById(`pp-${batchId}`).value || "",
    pickupTime: document.getElementById(`pt-${batchId}`).value || ""
  });

  fetch(API + "?" + params.toString())
    .then(r => r.json())
    .then(res => {
      if (res.error) throw new Error(res.error);

      assignmentsCache[batchId] = null;
      allocationCache[batchId] = null;

      return Promise.all([
        fetch(API + "?action=assignments&batchId=" + batchId).then(r => r.json()),
        fetch(API + "?action=batches").then(r => r.json())
      ]);
    })
    .then(([a, b]) => {
  assignmentsCache[batchId] = a;
  allocationCache[batchId] = []; // reset safely
  batches = b;


      btn.disabled = false;
      btn.innerText = "Save Assignment";

      render();

// ensure DOM is painted first
requestAnimationFrame(() => {
  toggleWorkspace(batchId);
});

    })
    .catch(err => {
      btn.disabled = false;
      btn.innerText = "Save Assignment";
      alert("Failed to save assignment: " + err.message);
      console.error(err);
    });
}
  
function lockVehicles(batchId, btn) {
  if (!confirm("Lock vehicles? You won‚Äôt be able to edit them later.")) return;

  btn.disabled = true;
  btn.innerText = "Locking‚Ä¶";

  fetch(API + "?action=lockVehicles&batchId=" + encodeURIComponent(batchId))
    .then(r => r.json())
    .then(res => {
      if (res.error) throw new Error(res.error);

      return fetch(API + "?action=batches").then(r => r.json());
    })
    .then(b => {
      batches = b;
      render();
      setTimeout(() => toggleWorkspace(batchId), 0);
    })
    .catch(err => {
      alert(err.message);
      btn.disabled = false;
      btn.innerText = "üîí Lock Vehicles";
    });
}


function cancelAlloc(id) {
  if (!confirm("Cancel this allocation?")) return;

  fetch(API + "?action=cancelAllocation&allocationId=" + encodeURIComponent(id))
    .then(r => r.json())
    .then(() => {
      allocationCache = {};
      render();
    })
    .catch(e => alert(e.message));
}

function editAlloc(id, current) {
  const n = prompt("Enter new pax count", current);
  if (!n || isNaN(n) || n <= 0) return;

  fetch(API + `?action=editAllocation&allocationId=${id}&newPax=${n}`)
    .then(r => r.json())
    .then(() => {
      allocationCache = {};
      render();
    })
    .catch(e => alert(e.message));
}

    </script>

</body>
</html>
